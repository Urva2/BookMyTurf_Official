<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slot Management | BookMyTurf Owner</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap"
    rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg-deep: #050505;
      --bg-card: #0c0c0c;
      --bg-panel: #141414;
      --accent: #14e7ff;
      --neon-green: #39ff14;
      --text-primary: #FFFFFF;
      --text-secondary: #B0B0B0;
      --text-muted: #555555;
      --border: rgba(255, 255, 255, 0.05);
      --radius-main: 24px;
      --radius-sub: 14px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-deep);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding: 40px;
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* --- TOP SECTION --- */
    .top-section {
      margin-bottom: 48px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 24px;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.03);
      padding: 8px 16px;
      border-radius: 100px;
      border: 1px solid var(--border);
    }

    .back-btn:hover {
      color: var(--accent);
      background: rgba(20, 231, 255, 0.05);
      border-color: rgba(20, 231, 255, 0.2);
    }

    .page-header h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 48px;
      font-weight: 700;
      letter-spacing: -1.5px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff 0%, #888 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-header p {
      color: var(--text-secondary);
      font-size: 18px;
    }

    /* --- ACTION TABS --- */
    .tabs-container {
      margin-bottom: 40px;
      padding: 6px;
      background: var(--bg-card);
      border-radius: 16px;
      display: inline-flex;
      border: 1px solid var(--border);
    }

    .tabs {
      display: flex;
      gap: 4px;
    }

    .tab {
      padding: 10px 24px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      border-radius: 12px;
      transition: var(--transition);
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.03);
    }

    .tab.active {
      color: var(--bg-deep);
      background: var(--accent);
      box-shadow: 0 4px 15px rgba(20, 231, 255, 0.3);
    }

    /* --- MAIN CONTENT AREA --- */
    .main-layout {
      display: grid;
      grid-template-columns: 7.5fr 3.5fr;
      gap: 32px;
    }

    .content-card {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-main);
      padding: 32px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    /* --- CALENDAR (LEFT) --- */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .month-year {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 700;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-panel);
      color: var(--text-primary);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .nav-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-2px);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .weekday {
      text-align: center;
      color: var(--text-muted);
      font-weight: 700;
      font-size: 10px;
      padding-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .date-cell {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sub);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      transition: var(--transition);
      cursor: pointer;
      padding: 8px;
      gap: 2px;
    }

    .date-cell:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-4px);
      border-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .date-cell .date-num {
      font-size: 16px;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
    }

    .date-cell .slot-count {
      font-size: 8px;
      font-weight: 700;
      color: var(--neon-green);
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .date-cell.selected {
      background: var(--neon-green);
      border-color: var(--neon-green);
      box-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
    }

    .date-cell.selected .date-num,
    .date-cell.selected .slot-count {
      color: #000;
    }

    .date-cell.today {
      border: 2px solid var(--accent);
    }

    /* --- SIDE PANEL (RIGHT) --- */
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .slot-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .slot-card:hover {
      border-color: rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.03);
    }

    .slot-info h4 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .slot-info .price {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-available {
      background: rgba(57, 255, 20, 0.1);
      color: var(--neon-green);
      border: 1px solid rgba(57, 255, 20, 0.2);
    }

    .status-booked {
      background: rgba(255, 71, 87, 0.1);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.2);
    }

    /* --- EDIT MODAL --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: grid;
      place-items: center;
      padding: 20px;
    }

    .modal-content {
      width: 100%;
      max-width: 450px;
      animation: modalSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-group input {
      width: 100%;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-family: inherit;
      transition: var(--transition);
    }

    .form-group input:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 15px rgba(20, 231, 255, 0.1);
    }

    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .btn-cancel {
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      text-align: center;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      transition: var(--transition);
    }

    .btn-save {
      padding: 12px;
      border-radius: 12px;
      background: var(--neon-green);
      color: #000;
      border: none;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-save:hover {
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.4);
      transform: translateY(-2px);
    }

    .action-icons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border);
      text-decoration: none;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
    }

    .icon-btn.delete:hover {
      background: rgba(255, 71, 87, 0.1);
      color: #ff4757;
      border-color: rgba(255, 71, 87, 0.2);
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      body {
        padding: 24px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- TOP SECTION -->
    {% if messages %}
    <div style="margin-bottom: 24px;">
      {% for message in messages %}
      <div
        style="padding: 16px; border-radius: 12px; margin-bottom: 8px; font-weight: 600; font-size: 14px; 
                  {% if message.tags == 'success' %} background: rgba(57, 255, 20, 0.1); color: var(--accent); border: 1px solid var(--accent);
                  {% else %} background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid #ff4757; {% endif %}">
        <i
          class="fa-solid {% if message.tags == 'success' %}fa-circle-check{% else %}fa-circle-exclamation{% endif %}"></i>
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <header class="top-section">
      <a href="{% url 'owner_dashboard' %}" class="back-link back-btn">
        <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
      </a>
      <div class="page-header">
        <h1>Slot Management</h1>
        <p>Manage your turf time slots with powerful scheduling tools</p>
      </div>
    </header>

    <!-- ACTION TABS -->
    <nav class="tabs-container">
      <div class="tabs">
        <a href="?date={{ selected_date|date:'Y-m-d' }}&tab=calendar"
          class="tab {% if not request.GET.tab or request.GET.tab == 'calendar' %}active{% endif %}">
          <i class="fa-solid fa-calendar-days" style="margin-right: 8px;"></i>Calendar View
        </a>
        <a href="?date={{ selected_date|date:'Y-m-d' }}&tab=add"
          class="tab {% if request.GET.tab == 'add' %}active{% endif %}">
          <i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i>Add Single Slot
        </a>
        <a href="?date={{ selected_date|date:'Y-m-d' }}&tab=bulk"
          class="tab {% if request.GET.tab == 'bulk' %}active{% endif %}">
          <i class="fa-solid fa-layer-group" style="margin-right: 8px;"></i>Bulk Generate
        </a>
      </div>
    </nav>

    {% if not request.GET.tab or request.GET.tab == 'calendar' %}
    <main class="main-layout">
      <!-- Left Side: Calendar -->
      <section class="content-card">
        <div class="calendar-header">
          <div class="month-year">{{ selected_date|date:"F Y" }}</div>
          <div class="nav-arrows">
            <a href="?date={{ selected_date|date:'Y-m-d' }}" class="nav-btn" style="text-decoration: none;"
              title="Reload">
              <i class="fa-solid fa-rotate"></i>
            </a>
          </div>
        </div>

        <div class="calendar-grid">
          <div class="weekday">Sun</div>
          <div class="weekday">Mon</div>
          <div class="weekday">Tue</div>
          <div class="weekday">Wed</div>
          <div class="weekday">Thu</div>
          <div class="weekday">Fri</div>
          <div class="weekday">Sat</div>

          <!-- Simplified Date Grid for Demonstration -->
          {% for day in "1234567890123456789012345678901"|make_list %}
          {% with day_num=forloop.counter %}
          <a href="?date={{ selected_date|date:'Y-m' }}-{{ day_num|stringformat:'02d' }}"
            class="date-cell {% if day_num == selected_date.day %}selected{% endif %} {% if day_num == today.day and selected_date.month == today.month and selected_date.year == today.year %}today{% endif %}"
            style="text-decoration: none; color: inherit;">
            <span class="date-num">{{ day_num }}</span>

            {% for d_key, count in slot_counts.items %}
            {% if d_key|slice:":7" == selected_date|date:"Y-m" and d_key|slice:"8:"|add:"0" == day_num %}
            <span class="slot-count">
              {{ count }} slot{{ count|pluralize }}
            </span>
            {% endif %}
            {% endfor %}
          </a>
          {% endwith %}
          {% endfor %}
        </div>
      </section>

      <!-- Right Side: Side Panel -->
      <aside class="side-panel">
        <div class="content-card" style="height: 100%; display: flex; flex-direction: column;">
          <div class="selected-date-header">
            <h2>Selected Date</h2>
            <p>{{ selected_date|date:"l, M d" }}</p>
          </div>

          <div class="slots-container" style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
            {% if selected_slots %}
            <div style="display: flex; flex-direction: column; gap: 12px;">
              {% for slot in selected_slots %}
              <div class="slot-card">
                <div class="slot-info">
                  <h4>{{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}</h4>
                  <div class="price">₹{{ slot.price }}</div>

                  <div class="action-icons">
                    {% if not slot.is_booked %}
                    <a href="?date={{ selected_date|date:'Y-m-d' }}&edit_id={{ slot.id }}" class="icon-btn"
                      title="Edit Slot"><i class="fa-solid fa-pen"></i></a>
                    {% endif %}
                    <a href="{% url 'delete_slot' slot.id %}" class="icon-btn delete" title="Delete Slot"
                      onclick="return confirm('Are you sure you want to delete this slot?')"><i
                        class="fa-solid fa-trash-can"></i></a>
                  </div>
                </div>

                <div class="status-badge {% if slot.is_booked %}status-booked{% else %}status-available{% endif %}">
                  {% if slot.label %}<span style="opacity: 0.6; margin-right: 8px;">{{ slot.label }}</span>{% endif %}
                  {% if slot.is_booked %}Booked{% else %}Available{% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="slots-placeholder">
              <i class="fa-regular fa-calendar-xmark"></i>
              <p>No slots for this day</p>
            </div>
            {% endif %}
          </div>
        </div>
      </aside>
    </main>
    {% elif request.GET.tab == 'add' %}
    <main class="main-layout">
      <section class="content-card">
        <div style="margin-bottom: 24px;">
          <h2 style="font-family: 'Poppins', sans-serif; font-size: 24px; margin-bottom: 8px;">Add Single Slot</h2>
          <p style="color: var(--text-secondary);">Configure a specific time slot for {{ selected_date|date:"l, M d, Y"
            }}</p>
        </div>

        <form action="" method="POST" style="display: grid; gap: 24px;">
          {% csrf_token %}
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Select Date</label>
            <input type="date" name="slot_date" id="single_slot_date" value="{{ selected_date|date:'Y-m-d' }}"
              min="{{ today|date:'Y-m-d' }}"
              style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Start Time</label>
              <select name="start_time"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
                {% if available_times %}
                {% for t in available_times %}
                <option value="{{ t|time:'H:i' }}">{{ t|time:"g A" }}</option>
                {% endfor %}
                {% else %}
                <option disabled>No available times for this date</option>
                {% endif %}
              </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Price (₹)</label>
              <input type="number" name="price" placeholder="e.g. 1500"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
            </div>
          </div>

          <div
            style="background: rgba(20, 231, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(20, 231, 255, 0.1);">
            <div style="display: flex; align-items: center; gap: 12px; color: var(--accent); margin-bottom: 8px;">
              <i class="fa-solid fa-circle-info"></i>
              <span style="font-weight: 600;">Slot Details</span>
            </div>
            <p style="font-size: 13px; color: var(--text-secondary);">All slots are exactly 1 hour. Selecting a start
              time will automatically generate a 1-hour duration. For example, 6 AM will create a slot for 6:00 AM -
              7:00 AM.</p>
          </div>

          <button type="submit"
            style="background: var(--accent); color: var(--bg-deep); border: none; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; transition: var(--transition); box-shadow: 0 4px 15px rgba(20, 231, 255, 0.2);">
            Create Time Slot
          </button>
        </form>
      </section>

      <aside class="side-panel">
        <div class="content-card">
          <div class="selected-date-header">
            <h2>Live Preview</h2>
            <p>{{ selected_date|date:"M d" }} Slots</p>
          </div>
          <div class="slots-container">
            {% if existing_slots %}
            <div style="display: flex; flex-direction: column; gap: 10px;">
              {% for slot in existing_slots %}
              <div
                style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px;">
                {{ slot.start_time|time:"g A" }} - {{ slot.end_time|time:"g A" }}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p style="color: var(--text-muted); font-size: 13px;">No existing slots yet.</p>
            {% endif %}
          </div>
        </div>
      </aside>
    </main>
    {% elif request.GET.tab == 'bulk' %}
    <main class="main-layout">
      <section class="content-card">
        <div style="margin-bottom: 24px;">
          <h2 style="font-family: 'Poppins', sans-serif; font-size: 24px; margin-bottom: 8px;">Bulk Slot Generation</h2>
          <p style="color: var(--text-secondary);">Automatically generate multiple slots across a date range</p>
        </div>

        {% if preview_count is not None %}
        <div
          style="background: rgba(57, 255, 20, 0.1); color: var(--accent); padding: 24px; border-radius: 12px; border: 1px solid var(--accent); margin-bottom: 32px; display: flex; flex-direction: column; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; font-weight: 700;">
            <i class="fa-solid fa-calculator" style="font-size: 20px;"></i>
            <span>Total slots to be generated: {{ preview_count }}</span>
          </div>
          <form action="" method="POST">
            {% csrf_token %}
            <input type="hidden" name="bulk_generate" value="true">
            <input type="hidden" name="action" value="confirm">
            <button type="submit"
              style="background: var(--accent); color: var(--bg-deep); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: var(--transition); width: fit-content; display: flex; align-items: center; gap: 8px;">
              <i class="fa-solid fa-check-double"></i>
              Confirm & Generate Slots
            </button>
          </form>
        </div>
        {% endif %}

        <form action="" method="POST" style="display: grid; gap: 32px;">
          {% csrf_token %}
          <input type="hidden" name="bulk_generate" value="true">

          <!-- Date Range & Config -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Start Date</label>
              <input type="date" name="start_date" id="bulk_start_date" value="{{ selected_date|date:'Y-m-d' }}"
                min="{{ today|date:'Y-m-d' }}"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">End Date</label>
              <input type="date" name="end_date" id="bulk_end_date" min="{{ today|date:'Y-m-d' }}"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Generation Mode</label>
              <select name="generation_mode"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
                <option value="all">All Days</option>
                <option value="weekday">Weekdays Only (Mon-Fri)</option>
                <option value="weekend">Weekends Only (Sat-Sun)</option>
              </select>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Conflict Strategy</label>
              <select name="conflict_strategy"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
                <option value="skip">Skip Conflicts</option>
                <option value="overwrite">Overwrite Existing (Keep Booked)</option>
              </select>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">Slot Duration
                (min)</label>
              <input type="number" name="duration" value="60"
                style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; font-size: 15px; width: 100%;">
            </div>
          </div>

          <!-- Time Blocks -->
          <div>
            <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--accent);">Time Blocks (Max 3)</h3>
            <div style="display: grid; gap: 16px;">
              {% for i in "123"|make_list %}
              <div
                style="display: flex; flex-direction: column; gap: 8px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--border);">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 12px; color: var(--text-muted);">Start Time</label>
                    <input type="time" name="block_{{ forloop.counter }}_start" id="block_{{ forloop.counter }}_start"
                      class="time-input" data-block="{{ forloop.counter }}"
                      style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 8px; padding: 8px; color: #fff;">
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 12px; color: var(--text-muted);">End Time</label>
                    <input type="time" name="block_{{ forloop.counter }}_end" id="block_{{ forloop.counter }}_end"
                      class="time-input" data-block="{{ forloop.counter }}"
                      style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 8px; padding: 8px; color: #fff;">
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <label style="font-size: 12px; color: var(--text-muted);">Price (₹)</label>
                    <input type="number" name="block_{{ forloop.counter }}_price" placeholder="Price"
                      style="background: var(--bg-deep); border: 1px solid var(--border); border-radius: 8px; padding: 8px; color: #fff;">
                  </div>
                </div>
                <div id="error_block_{{ forloop.counter }}" class="block-error"
                  style="color: #ff4d4d; font-size: 12px; display: none; align-items: center; gap: 4px;">
                  <i class="fa-solid fa-circle-exclamation"></i>
                  <span class="error-text"></span>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>

          <button type="submit" name="action" value="preview"
            style="background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; transition: var(--transition);">
            <i class="fa-solid fa-magnifying-glass" style="margin-right: 8px;"></i>
            Preview Generation
          </button>
        </form>
      </section>

      <aside class="side-panel">
        <div class="content-card">
          <div
            style="background: rgba(20, 231, 255, 0.05); padding: 24px; border-radius: 16px; border: 1px solid rgba(20, 231, 255, 0.1);">
            <div style="display: flex; align-items: center; gap: 12px; color: var(--accent); margin-bottom: 12px;">
              <i class="fa-solid fa-circle-info" style="font-size: 20px;"></i>
              <h3 style="font-weight: 700;">Bulk Guide</h3>
            </div>
            <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
              First, click <strong>Preview Generation</strong> to calculate the exact number of slots. Once the count is
              shown, use the <strong>Confirm</strong> button to save them to the database.
            </p>
          </div>
        </div>
      </aside>
    </main>
    {% endif %}
  </div>
  <script>
    const startDateInput = document.getElementById('bulk_start_date');
    const endDateInput = document.getElementById('bulk_end_date');
    const previewBtn = document.querySelector('button[value="preview"]');
    const timeInputs = document.querySelectorAll('.time-input');

    // Date picker constraints
    if (startDateInput && endDateInput) {
      startDateInput.addEventListener('change', function () {
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
          endDateInput.value = this.value;
        }
      });
    }

    // Time block validation
    function validateBlocks() {
      let hasError = false;
      const blocks = [];

      // Reset errors
      document.querySelectorAll('.block-error').forEach(el => {
        el.style.display = 'none';
        el.querySelector('.error-text').textContent = '';
      });

      // 1. Collect and Validate individual blocks
      for (let i = 1; i <= 3; i++) {
        const start = document.getElementById(`block_${i}_start`).value;
        const end = document.getElementById(`block_${i}_end`).value;

        if (start && end) {
          if (start >= end) {
            showError(i, "Start time must be before end time.");
            hasError = true;
          } else {
            blocks.push({ id: i, start, end });
          }
        }
      }

      // 2. Check for overlaps between blocks
      for (let i = 0; i < blocks.length; i++) {
        for (let j = i + 1; j < blocks.length; j++) {
          const b1 = blocks[i];
          const b2 = blocks[j];

          // Overlap condition: (StartA < EndB) and (EndA > StartB)
          if (b1.start < b2.end && b1.end > b2.start) {
            showError(b1.id, `Overlaps with Block ${b2.id}`);
            showError(b2.id, `Overlaps with Block ${b1.id}`);
            hasError = true;
          }
        }
      }

      // Disable/Enable preview button
      if (previewBtn) {
        previewBtn.disabled = hasError;
        previewBtn.style.opacity = hasError ? '0.5' : '1';
        previewBtn.style.cursor = hasError ? 'not-allowed' : 'pointer';
      }
    }

    function showError(blockId, message) {
      const errorDiv = document.getElementById(`error_block_${blockId}`);
      if (errorDiv) {
        errorDiv.style.display = 'flex';
        errorDiv.querySelector('.error-text').textContent = message;
      }
    }

    // Add listeners to all time inputs
    timeInputs.forEach(input => {
      input.addEventListener('change', validateBlocks);
    });

    // Single Slot Date sync
    const singleSlotDateInput = document.getElementById('single_slot_date');
    if (singleSlotDateInput) {
      singleSlotDateInput.addEventListener('change', function () {
        const newDate = this.value;
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('date', newDate);
        urlParams.set('tab', 'add');
        window.location.search = urlParams.toString();
      });
    }
  </script>
  {% if edit_slot_obj %}
  <div class="modal-overlay">
    <div class="modal-content content-card">
      <h2 style="margin-bottom: 24px;">Edit Time Slot</h2>
      <form method="POST" class="modal-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit_slot">
        <input type="hidden" name="slot_id" value="{{ edit_slot_obj.id }}">

        <div class="form-group">
          <label>Start Time</label>
          <input type="time" name="start_time" value="{{ edit_slot_obj.start_time|time:'H:i' }}" required>
        </div>

        <div class="form-group">
          <label>End Time</label>
          <input type="time" name="end_time" value="{{ edit_slot_obj.end_time|time:'H:i' }}" required>
        </div>

        <div class="form-group">
          <label>Price (₹)</label>
          <input type="number" name="price" value="{{ edit_slot_obj.price }}" step="0.01" required>
        </div>

        <div class="form-group">
          <label>Label (Optional)</label>
          <input type="text" name="label" value="{{ edit_slot_obj.label }}" placeholder="e.g. Morning Special">
        </div>

        <div class="modal-actions">
          <a href="?date={{ selected_date|date:'Y-m-d' }}" class="btn-cancel">Cancel</a>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</body>

</html>